# Azure Function App

This section decribes Azure Function App that handles the messages received
from Slack.

NOTE: the scrips utilize `developer-settings.json`. Make sure that that the
file has correct configuration values. Correct configuration values require
that the Slack App is already created, because OAuth Bearer token is created by
Slack App.

NOTE: Following scripts may throw `The underlying connection was closed: An unexpected error occurred on a send.`
or similar error if wrong `SecurityProtocol` is used by Powershell. This
requires TLS 1.2.

Following will fix the issue for PowerShell session

```powershell
[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12;
```

## Creating the environment

Following steps require [Azure Powershell module](https://docs.microsoft.com/en-us/powershell/azure/install-az-ps)

1. Azure PowerShell needs to have an authenticated sessions. This can be done with `Connect-AzAccount`.
1. Execute `./Deployment/Prepare-Environment.ps1`. This script creates services
to Azure, compiles the software and publishes the binaries.

Note: If you wish to use the Console Application, save `tableStorageConnection`
that is generated by the deployment. This can be later fetched from table
storage settings. This is used by ConsoleInterface to manage questionnaires.

## Retrieving Function URI

The function uri is required by Slack App so it can messages to correct
Azure Function App. This is printed during `Prepare-Environment.ps1` but it can
also be retrieved with `Deployment/Get-FunctionUri.ps1` or from Azure Portal.

```powershell
.\Deployment\Get-FunctionUri.ps1 -ResourceGroup 'my-resource-group' -FunctionName 'AskBotHook'
```

Example output

```txt
Getting credentials from RG slack-ask-bot-dev for APP slack-ask-bot-dev
https://slack-ask-bot-dev.azurewebsites.net/api/askbothook?code=mockcodehere
```

## Publishing application without environment setup

This step is not necessary because `Prepare-Environment.ps1` is designed to be
idempotent. However, it can be slow, so binaries can be published in separate
step.

The following will build and publish this application

```bash
pwsh ./Deployment/Publish.ps1 -ResourceGroup "my-resource-group" -WebAppName "my-function-app-name"
```

```powershell
.\Deployment\Publish.ps1 -ResourceGroup "my-resource-group" -WebAppName "my-function-app-name"
```
